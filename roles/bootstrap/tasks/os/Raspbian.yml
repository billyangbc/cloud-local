---
# enable cgroup memory
## NOTE: if not set cgroup, cluster will hang at creating servers
# - name: Set cgroup on Raspberry pi (arm64)
#   lineinfile:
#     path: /boot/firmware/cmdline.txt
#     regexp: '^(.*rootwait.*)$' # rootfstype=ext4 fsck.repair=yes rootwait quiet splash
#     line: '\1 cgroup_memory=1 cgroup_enable=memory'
#     backrefs: true
#   when: ( ansible_facts.architecture is search "arm" )
#   notify:
#     - reboot-server
- name: Check if /boot/firmware/cmdline.txt exists
  ansible.builtin.stat:
    path: /boot/firmware/cmdline.txt
  register: boot_firmware_cmdline_txt

- name: Enable cgroup via boot commandline if not already enabled
  ansible.builtin.replace:
    path: "{{ (boot_firmware_cmdline_txt.stat.exists) | ternary('/boot/firmware/cmdline.txt', '/boot/cmdline.txt') }}"
    regexp: '^([\w](?!.*\b{{ cgroup_item }}\b).*)$'
    replace: '\1 {{ cgroup_item }}'
  with_items:
    - "cgroup_enable=cpuset"
    - "cgroup_memory=1"
    - "cgroup_enable=memory"
  loop_control:
    loop_var: cgroup_item
  notify: Reboot Pi

- name: Gather the package facts
  ansible.builtin.package_facts:
    manager: auto
